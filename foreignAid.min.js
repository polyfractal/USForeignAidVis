function addCommas(b){b+="";x=b.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";var a=/(\d+)(\d{3})/;while(a.test(x1)){x1=x1.replace(a,"$1,$2")}return x1+x2}function roundNumber(a,b){return result=Math.round(a*Math.pow(10,b))/Math.pow(10,b)}var xy=d3.geo.mercator();var path=d3.geo.path().projection(xy);var currentYear=1946;var dxy={};dxy.mousedown=false;dxy.zooming=false;dxy.zoomLevel=500;d3.select(window).on("keydown",function(){if(d3.event.keyCode==17){dxy.zooming=true}}).on("keyup",function(){dxy.zooming=false}).on("mouseup",function(a){if(dxy.mousedown==true){dxy.mousedown=false}else{if(dxy.zooming==true){dxy.zooming=false}}});var countries=d3.select("body").append("svg").attr("width",960).attr("height",350).on("mousedown",function(a){dxy.mousedown=true;dxy.start=d3.svg.mouse(this);dxy.end=d3.svg.mouse(this)}).on("mousemove",function(a){if(dxy.mousedown==true||dxy.zooming){dxy.end=d3.svg.mouse(this);refresh()}}).append("g").attr("id","countries");var equator=d3.select("svg").append("line").attr("class","equator").attr("x1","0%").attr("x2","100%");var numBars=64;var barHeight=80;var x=d3.scale.linear().domain([0,1]).range([0,960/numBars]);var y=d3.scale.linear().domain([0,40000000000]).rangeRound([0,barHeight]);var chart=d3.select("body").append("svg:svg").attr("class","chart").attr("width",960).attr("height",barHeight);var totalSpending=[];var totalSpendingHistorical=[];var totalSpendingAdjusted=[];var greenbook;var greenbookHistorical;var greenbookAdjusted;var originalGreenbook;var currentCountry="";var cpi;var useHistorical=true;var max=0;var fill;d3.json("data/world-countries.json",function(a){countries.selectAll("path").data(a.features).enter().append("path").attr("d",path).attr("id",function(b){return b.properties.name}).attr("fill","#ccc").on("click",function(b){$("#dataTitle h2").text(b.properties.name);currentCountry=b.properties.name;refresh()}).append("title").text(function(b){return b.properties.name});equator.attr("y1",xy([0,0])[1]).attr("y2",xy([0,0])[1])});d3.csv("data/cpi.csv",function(a){cpi=d3.nest().key(function(b){return b.Year}).map(a);d3.csv("data/greenbook.csv",function(c){greenbookHistorical=d3.nest().key(function(f){return f.country_name}).rollup(function(f){var h={};for(var k=1946;k<=2009;k++){var j="FY"+k;for(var g in f){if(h[k]==null){h[k]=parseInt(f[g][j])}else{h[k]+=parseInt(f[g][j])}}if(h[k]>max){max=h[k]}}return h}).map(c);greenbookAdjusted=d3.nest().key(function(f){return f.country_name}).rollup(function(f){var h={};for(var k=1946;k<=2009;k++){var j="FY"+k;for(var g in f){if(h[k]==null){h[k]=parseInt(f[g][j])/(parseInt(cpi[k][0]["CPI"])/100)}else{h[k]+=parseInt(f[g][j])/(parseInt(cpi[k][0]["CPI"])/100)}}if(h[k]>max){max=h[k]}h[k]=Math.round(h[k])}return h}).map(c);originalGreenbook=d3.nest().key(function(f){return f.country_name}).map(c);var b=true;for(var d in greenbookHistorical){for(var e=1946;e<=2009;e++){if(b){totalSpendingHistorical[e-1946]=parseInt(greenbookHistorical[d][e]);totalSpendingAdjusted[e-1946]=parseInt(greenbookAdjusted[d][e])}else{totalSpendingHistorical[e-1946]+=parseInt(greenbookHistorical[d][e]);totalSpendingAdjusted[e-1946]+=parseInt(greenbookAdjusted[d][e])}}b=false}if(useHistorical){greenbook=greenbookHistorical;totalSpending=totalSpendingHistorical}else{greenbook=greenbookAdjusted;totalSpending=totalSpendingAdjusted}chart.selectAll("rect").data(totalSpending).enter().append("svg:rect").attr("x",function(g,f){return x(f)-0.5}).attr("y",function(f){return barHeight-y(f)-0.5}).attr("width",(960/numBars)-2).attr("height",function(f){return y(f)}).attr("id",function(g,f){return f+1946}).on("mouseover",function(g,f){d3.select(this).attr("fill","red").append("title").text("$"+addCommas(totalSpending[f]))}).on("mouseout",function(f){refreshChart()}).on("click",function(f){currentYear=parseInt(d3.select(this).attr("id"));$("#currentYear").slider({value:currentYear});refresh()});fill=d3.scale.sqrt().domain([1,max]).range(["#ccc","red"]);refresh()})});function formatDataTable(){if(currentCountry!=""){$("#dataTitle h2").text(currentCountry+": $"+addCommas(greenbook[currentCountry][currentYear]));$("#dataTable tbody tr").remove();for(program in originalGreenbook[currentCountry]){value=originalGreenbook[currentCountry][program]["FY"+currentYear];if(value!=0){if(useHistorical){$("#dataTable tbody").append("<tr><td>"+originalGreenbook[currentCountry][program]["program_name"]+"</td><td>$"+addCommas(originalGreenbook[currentCountry][program]["FY"+currentYear])+"</td></tr>")}else{$("#dataTable tbody").append("<tr><td>"+originalGreenbook[currentCountry][program]["program_name"]+"</td><td>$"+addCommas(Math.round((originalGreenbook[currentCountry][program]["FY"+currentYear])/(parseInt(cpi[currentYear][0]["CPI"])/100)))+"</td></tr>")}}}}}function refreshChart(){chart.selectAll("rect").attr("fill",function(b,a){if(a+1946===currentYear){return"red"}else{return"black"}})}function refresh(){if(dxy.mousedown&&!dxy.zooming){var c=xy.translate();c[0]+=dxy.end[0]-dxy.start[0];c[1]+=dxy.end[1]-dxy.start[1];xy.translate(c);dxy.start=dxy.end}else{if(dxy.mousedown&&dxy.zooming){dxy.zoomLevel+=(dxy.end[1]-dxy.start[1])*0.3;xy.scale(dxy.zoomLevel)}}formatDataTable();countries.selectAll("path").attr("d",path);for(var b in greenbook){try{if(greenbook[b][currentYear]!=0&&greenbook[b][currentYear]>0){countries.select("#"+b).attr("fill",fill(greenbook[b][currentYear])).select("title").text(b+" - $"+addCommas(greenbook[b][currentYear]))}else{countries.select("#"+b).attr("fill","#ccc")}}catch(a){}}refreshChart();equator.attr("y1",xy([0,0])[1]).attr("y2",xy([0,0])[1]);$("#dataYear h1").text(currentYear+": $"+addCommas(parseInt(totalSpending[currentYear-1946])))}function redrawGraphs(){if(useHistorical){greenbook=greenbookHistorical;totalSpending=totalSpendingHistorical}else{greenbook=greenbookAdjusted;totalSpending=totalSpendingAdjusted}chart.selectAll("rect").data(totalSpending).transition().duration(1000).attr("y",function(a){return barHeight-y(a)-0.5}).attr("height",function(a){return y(a)})};